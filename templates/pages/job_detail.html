{% extends "base.html" %}

{% block title %}Job #{{ job_id }} | WP Scrap{% endblock %}

{% block extra_head %}
{{ super() }}
<link rel="stylesheet" href="/static/css/jobs.css">
<link rel="stylesheet" href="/static/css/job-detail.css">
{% endblock %}

{% block content %}
<div class="job-detail-page" data-job-id="{{ job_id }}">
  <div class="breadcrumb">
    <a href="/">Dashboard</a>
    <span class="breadcrumb-separator">/</span>
    <a href="/jobs">Jobs</a>
    <span class="breadcrumb-separator">/</span>
    <span>Job #{{ job_id }}</span>
  </div>

  <div id="loadingState" class="loading-state job-detail-loading">
    <div class="spinner"></div>
    <p class="loading-text">Cargando job...</p>
  </div>

  <div id="contentContainer" class="job-detail-content hidden">
    <div class="job-detail-header">
      <div class="job-detail-header-top">
        <div class="job-detail-title">
          <h1 id="jobName" class="job-detail-name"></h1>
          <p id="jobDescription" class="job-detail-description"></p>
        </div>
        <div class="job-detail-actions">
          <button id="cancelJobBtn" class="btn-danger hidden">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Cancelar Job
          </button>
          <button id="refreshBtn" class="btn-refresh">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Actualizar
          </button>
        </div>
      </div>

      <div class="job-detail-status">
        <span id="statusBadge" class="status-badge status-pending">Pendiente</span>
      </div>

      <div class="job-progress">
        <div class="progress-header">
          <span class="progress-label">Progreso del trabajo</span>
          <span id="progressText" class="progress-percent">0%</span>
        </div>
        <div class="progress-bar-container">
          <div id="progressBar" class="progress-bar" style="width: 0%"></div>
        </div>
      </div>

      <div class="job-metrics">
        <div class="metric-card total">
          <div id="totalSteps" class="metric-value">0</div>
          <div class="metric-label">Total pasos</div>
        </div>
        <div class="metric-card completed">
          <div id="completedSteps" class="metric-value">0</div>
          <div class="metric-label">Completados</div>
        </div>
        <div class="metric-card failed">
          <div id="failedSteps" class="metric-value">0</div>
          <div class="metric-label">Fallidos</div>
        </div>
        <div class="metric-card pending">
          <div id="pendingSteps" class="metric-value">0</div>
          <div class="metric-label">Pendientes</div>
        </div>
      </div>

      <div class="job-detail-meta">
        <div class="meta-item">
          <span class="meta-label">Tipo</span>
          <span id="jobType" class="meta-value"></span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Creado</span>
          <span id="createdAt" class="meta-value"></span>
        </div>
        <div class="meta-item">
          <span class="meta-label">Actualizado</span>
          <span id="updatedAt" class="meta-value">—</span>
        </div>
        <div class="meta-item">
          <span class="meta-label">ID</span>
          <span class="meta-value">#{{ job_id }}</span>
        </div>
      </div>
    </div>

    <div class="job-detail-tabs">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="steps">
          <span>Pasos</span>
        </button>
        <button class="tab-btn" data-tab="comments">
          <span>Comentarios</span>
          <span id="commentCount" class="tab-badge">0</span>
        </button>
        <button class="tab-btn" data-tab="config">
          <span>Configuración</span>
        </button>
      </div>

      <div class="tab-panels">
        <div id="stepsTab" class="tab-content">
          <div class="job-detail-card">
            <h2 class="job-detail-card-title">Pasos del job</h2>
            <div id="stepsContainer" class="job-steps-list"></div>
          </div>
        </div>

        <div id="commentsTab" class="tab-content hidden">
          <div class="job-detail-card">
            <h2 class="job-detail-card-title">Comentarios</h2>
            <form id="commentForm" class="job-comment-form">
              <div class="job-detail-form-group">
                <label for="commentAuthor">Tu nombre</label>
                <input type="text" id="commentAuthor" class="job-detail-input" required>
              </div>
              <div class="job-detail-form-group">
                <label for="commentContent">Comentario</label>
                <textarea id="commentContent" rows="3" class="job-detail-input" required></textarea>
              </div>
              <div class="job-comment-actions">
                <button type="submit" class="btn-primary">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                  </svg>
                  Publicar comentario
                </button>
              </div>
            </form>

            <div id="commentsContainer" class="job-comments-list"></div>
          </div>
        </div>

        <div id="configTab" class="tab-content hidden">
          <div class="job-detail-card">
            <h2 class="job-detail-card-title">Configuración del job</h2>
            <pre id="configContent" class="job-config"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const rootEl = document.querySelector('.job-detail-page');
const jobId = Number(rootEl?.dataset.jobId || 0);
if (!jobId) {
  console.error('No se pudo determinar el ID del job.');
}
let job = null;
let refreshInterval = null;

const statusClassMap = {
  pending: 'status-pending',
  running: 'status-running',
  completed: 'status-completed',
  failed: 'status-failed',
  cancelled: 'status-cancelled'
};

const statusLabelMap = {
  pending: 'Pendiente',
  running: 'En ejecución',
  completed: 'Completado',
  failed: 'Fallido',
  cancelled: 'Cancelado'
};

const dateOptions = {
  year: 'numeric',
  month: 'short',
  day: 'numeric',
  hour: '2-digit',
  minute: '2-digit'
};

function formatDate(value) {
  if (!value) {
    return '—';
  }
  try {
    return new Date(value).toLocaleString('es-ES', dateOptions);
  } catch (error) {
    console.error('Error formateando fecha:', error);
    return value;
  }
}

async function loadJob() {
  try {
    const response = await fetch(`/api/jobs/${jobId}`);
    const data = await response.json();

    if (data.success) {
      job = data.job;
      renderJob();
      document.getElementById('loadingState').style.display = 'none';
      document.getElementById('contentContainer').classList.remove('hidden');
    } else {
      alert('Error cargando job');
    }
  } catch (error) {
    console.error('Error cargando job:', error);
    alert('Error cargando job');
  }
}

function renderJob() {
  document.getElementById('jobName').textContent = job.name;
  document.getElementById('jobDescription').textContent = job.description || 'Sin descripción';

  const status = job.status || 'pending';
  const statusBadge = document.getElementById('statusBadge');
  statusBadge.textContent = statusLabelMap[status] || status;
  statusBadge.className = `status-badge ${statusClassMap[status] || 'status-pending'}`;

  const cancelButton = document.getElementById('cancelJobBtn');
  if (status === 'running' || status === 'pending') {
    cancelButton.classList.remove('hidden');
  } else {
    cancelButton.classList.add('hidden');
  }

  const completedSteps = Number(job.completed_steps) || 0;
  const totalSteps = Number(job.total_steps) || 0;
  const failedSteps = Number(job.failed_steps) || 0;
  const progress = Math.max(0, Math.min(Number(job.progress_percentage) || 0, 100));
  const pendingSteps = Math.max(totalSteps - completedSteps - failedSteps, 0);

  document.getElementById('progressText').textContent = `${progress}% (${completedSteps}/${totalSteps})`;
  document.getElementById('progressBar').style.width = `${progress}%`;

  document.getElementById('totalSteps').textContent = totalSteps;
  document.getElementById('completedSteps').textContent = completedSteps;
  document.getElementById('failedSteps').textContent = failedSteps;
  document.getElementById('pendingSteps').textContent = pendingSteps;

  document.getElementById('jobType').textContent = job.job_type || '—';
  document.getElementById('createdAt').textContent = formatDate(job.created_at);
  document.getElementById('updatedAt').textContent = formatDate(job.updated_at);

  renderSteps();

  const configContent = document.getElementById('configContent');
  configContent.textContent = job.config ? JSON.stringify(job.config, null, 2) : 'Sin configuración disponible';
}

function renderSteps() {
  const container = document.getElementById('stepsContainer');

  if (!job.steps || job.steps.length === 0) {
    container.innerHTML = '<div class="job-empty-state">No hay pasos registrados para este job.</div>';
    return;
  }

  const statusIcons = {
    pending: '<svg class="job-step-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
    running: '<svg class="job-step-icon spinning" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>',
    completed: '<svg class="job-step-icon success" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
    failed: '<svg class="job-step-icon danger" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
  };

  container.innerHTML = job.steps.map((step) => {
    const icon = statusIcons[step.status] || statusIcons.pending;
    const statusClass = `job-step-card ${step.status || 'pending'}`;
    const completedAt = step.completed_at ? formatDate(step.completed_at) : null;
    const reportLink = step.result_data?.report_id ? `<a class="job-step-link" href="/report/${step.result_data.report_id}">Ver reporte</a>` : '';

    return `
      <div class="${statusClass}">
        <div class="job-step-header">
          ${icon}
          <div class="job-step-title">
            <span>Paso ${step.step_number}: ${step.name}</span>
            <span class="job-step-status">${statusLabelMap[step.status] || 'Pendiente'}</span>
          </div>
        </div>
        ${step.description ? `<p class="job-step-description">${step.description}</p>` : ''}
        ${step.error_message ? `<p class="job-step-error">Error: ${step.error_message}</p>` : ''}
        ${(completedAt || reportLink) ? `<div class="job-step-meta">
          ${completedAt ? `<span>Completado: ${completedAt}</span>` : ''}
          ${reportLink}
        </div>` : ''}
      </div>
    `;
  }).join('');
}

async function loadComments() {
  try {
    const response = await fetch(`/api/comments/job/${jobId}`);
    const data = await response.json();

    if (data.success) {
      renderComments(data.comments || []);
      document.getElementById('commentCount').textContent = data.count ?? data.comments.length;
    }
  } catch (error) {
    console.error('Error cargando comentarios:', error);
  }
}

function renderComments(comments) {
  const container = document.getElementById('commentsContainer');

  if (!comments.length) {
    container.innerHTML = '<div class="job-empty-state">No hay comentarios todavía.</div>';
    return;
  }

  container.innerHTML = comments.map((comment) => `
    <div class="job-comment-card">
      <div class="job-comment-header">
        <span class="job-comment-author">${comment.author}</span>
        <span class="job-comment-date">${formatDate(comment.created_at)}</span>
      </div>
      <p class="job-comment-content">${comment.content}</p>
    </div>
  `).join('');
}

document.getElementById('commentForm').addEventListener('submit', async (event) => {
  event.preventDefault();

  const author = document.getElementById('commentAuthor').value.trim();
  const content = document.getElementById('commentContent').value.trim();

  if (!author || !content) {
    return;
  }

  try {
    const response = await fetch('/api/comments/job', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        object_id: jobId,
        author,
        content
      })
    });

    const data = await response.json();

    if (data.success) {
      event.target.reset();
      loadComments();
    } else {
      alert('Error publicando comentario');
    }
  } catch (error) {
    console.error('Error publicando comentario:', error);
    alert('Error publicando comentario');
  }
});

document.getElementById('cancelJobBtn').addEventListener('click', async () => {
  if (!confirm('¿Estás seguro de que quieres cancelar este job?')) {
    return;
  }

  try {
    const response = await fetch(`/api/jobs/${jobId}/cancel`, { method: 'POST' });
    const data = await response.json();

    if (data.success) {
      loadJob();
    } else {
      alert('Error cancelando job');
    }
  } catch (error) {
    console.error('Error cancelando job:', error);
    alert('Error cancelando job');
  }
});

document.getElementById('refreshBtn').addEventListener('click', () => {
  loadJob();
  loadComments();
});

document.querySelectorAll('.tab-btn').forEach((button) => {
  button.addEventListener('click', () => {
    const tabName = button.dataset.tab;

    document.querySelectorAll('.tab-btn').forEach((btn) => btn.classList.remove('active'));
    button.classList.add('active');

    document.querySelectorAll('.tab-content').forEach((panel) => panel.classList.add('hidden'));
    document.getElementById(`${tabName}Tab`).classList.remove('hidden');

    if (tabName === 'comments') {
      loadComments();
    }
  });
});

function startAutoRefresh() {
  if (refreshInterval) {
    clearInterval(refreshInterval);
  }

  refreshInterval = setInterval(() => {
    if (job && (job.status === 'running' || job.status === 'pending')) {
      loadJob();
    }
  }, 5000);
}

document.addEventListener('DOMContentLoaded', () => {
  loadJob();
  loadComments();
  startAutoRefresh();
});

window.addEventListener('beforeunload', () => {
  if (refreshInterval) {
    clearInterval(refreshInterval);
  }
});
</script>
{% endblock %}
